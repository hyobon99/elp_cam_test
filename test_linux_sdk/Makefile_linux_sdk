# Linux SDK Professional Viewer Makefile
# ELP H.264 USB Camera SDK 기반

# 컴파일러 및 플래그
CC = gcc
CXX = g++
CFLAGS = -Wall -Wextra -O2 -g
CXXFLAGS = $(CFLAGS) -std=c++11

# 라이브러리
LIBS = -lpthread -lX11 -lm

# Linux SDK 헤더 경로 (실제 SDK 경로로 수정 필요)
SDK_PATH = ../LINUX\ 开发包-2/ELP\ Linux\ SDK最新/Linux
SDK_INCLUDE = -I$(SDK_PATH)/OSD-Linux_H264_AP_0724

# 소스 파일들
SOURCES = main_linux_sdk.cpp linux_sdk_viewer.cpp
SDK_SOURCES = $(SDK_PATH)/OSD-Linux_H264_AP_0724/h264_xu_ctrls.c \
              $(SDK_PATH)/OSD-Linux_H264_AP_0724/v4l2uvc.c \
              $(SDK_PATH)/OSD-Linux_H264_AP_0724/nalu.c \
              $(SDK_PATH)/OSD-Linux_H264_AP_0724/cap_desc.c \
              $(SDK_PATH)/OSD-Linux_H264_AP_0724/cap_desc_parser.c

# 오브젝트 파일들
OBJECTS = $(SOURCES:.cpp=.o) $(SDK_SOURCES:.c=.o)

# 타겟
TARGET = linux_sdk_viewer

# 기본 타겟
all: $(TARGET)

# 메인 타겟 빌드
$(TARGET): $(OBJECTS)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS)
	@echo "빌드 완료: $(TARGET)"

# C++ 소스 컴파일
%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(SDK_INCLUDE) -c $< -o $@

# C 소스 컴파일 (SDK 파일들)
%.o: %.c
	$(CC) $(CFLAGS) $(SDK_INCLUDE) -c $< -o $@

# 정리
clean:
	rm -f $(OBJECTS) $(TARGET)
	@echo "정리 완료"

# 설치 (선택적)
install: $(TARGET)
	sudo cp $(TARGET) /usr/local/bin/
	@echo "설치 완료: /usr/local/bin/$(TARGET)"

# 제거
uninstall:
	sudo rm -f /usr/local/bin/$(TARGET)
	@echo "제거 완료"

# 도움말
help:
	@echo "=== Linux SDK Professional Viewer ==="
	@echo "make all        - 빌드"
	@echo "make clean      - 정리"
	@echo "make install    - 시스템 설치"
	@echo "make uninstall  - 시스템 제거"
	@echo "make help       - 이 도움말"
	@echo ""
	@echo "=== 사용법 ==="
	@echo "./$(TARGET) [옵션]"
	@echo "  -d <device>   카메라 장치 (기본: /dev/video0)"
	@echo "  -w <width>    해상도 너비 (기본: 640)"
	@echo "  -h <height>   해상도 높이 (기본: 480)"
	@echo "  -f <fps>      FPS (기본: 30)"
	@echo "  -b <bitrate>  비트레이트 (H.264용)"
	@echo "  -q <quality>  품질 (H.264용)"
	@echo "  -F <format>   포맷 (0x00000021=H.264, 0x47504A4D=MJPEG)"
	@echo ""
	@echo "=== 예시 ==="
	@echo "./$(TARGET) -d /dev/video0 -w 1280 -h 720 -f 30"
	@echo "./$(TARGET) -d /dev/video1 -w 1920 -h 1080 -f 60 -F 0x00000021"

# 의존성 체크
check-deps:
	@echo "=== 의존성 체크 ==="
	@which $(CC) > /dev/null && echo "✓ GCC 설치됨" || echo "✗ GCC 필요"
	@which $(CXX) > /dev/null && echo "✓ G++ 설치됨" || echo "✗ G++ 필요"
	@pkg-config --exists x11 && echo "✓ X11 개발 라이브러리 설치됨" || echo "✗ X11 개발 라이브러리 필요"
	@echo "=================="

# SDK 경로 체크
check-sdk:
	@echo "=== SDK 경로 체크 ==="
	@if [ -d "$(SDK_PATH)" ]; then \
		echo "✓ SDK 경로 발견: $(SDK_PATH)"; \
		ls -la "$(SDK_PATH)"; \
	else \
		echo "✗ SDK 경로 없음: $(SDK_PATH)"; \
		echo "SDK_PATH 변수를 올바른 경로로 수정하세요"; \
	fi
	@echo "===================="

# 전체 체크
check: check-deps check-sdk
	@echo "=== 전체 체크 완료 ==="

.PHONY: all clean install uninstall help check-deps check-sdk check
